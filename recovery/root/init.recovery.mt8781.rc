import /init.trustkernel.rc
import /vendor/etc/init/trustkernel.rc

#---------------------------------------------------------------------
# Early Initialization
#---------------------------------------------------------------------
# Triggered first during the init process.
on init
    # Configure USB properties for File-based FDE (configfs)
    setprop sys.usb.configfs 1
    setprop sys.usb.controller "musb-hdrc"
    setprop sys.usb.ffs.aio_compat 0
    export LD_LIBRARY_PATH /system/lib64:/vendor/lib64:/vendor/lib64/hw

#---------------------------------------------------------------------
# Filesystem Triggers
#---------------------------------------------------------------------
# Triggered once basic filesystems (like /system, /vendor) are mounted.
on fs
    # Install the keyring for verifying mapped partitions
    install_keyring

    # Wait for the UFS storage device to become available
    wait /dev/block/platform/soc/11270000.ufshci
    # Create a standard symlink for the main boot storage device
    symlink /dev/block/platform/soc/11270000.ufshci /dev/block/bootdevice

# Conditionally triggered on 'fs' if the build is not a debug build.
on fs && property:ro.debuggable=0
    # Set the USB controller mode
    write /sys/class/udc/musb-hdrc/device/cmode 2
    # Start the ADB daemon for debugging
    start adbd

# We need vold early for metadata encryption
on early-fs
    start vold

# Triggered after 'fs' but before 'post-fs'.
on late-fs
    # Mount partitions that are marked as 'late' in the fstab
    mount_all /first_stage_ramdisk/fstab.mt8781 --late

# Triggered after 'fs' and 'late-fs' are complete.
on post-fs
    # Start the boot HAL (Hardware Abstraction Layer)
    start boot-hal-1-2

    # Create symlinks for mapped preloader partitions (Slot A/B)
    symlink /dev/block/mapper/pl_a /dev/block/by-name/preloader_raw_a
    symlink /dev/block/mapper/pl_b /dev/block/by-name/preloader_raw_b

# Triggered after the /data partition has been successfully mounted.
on post-fs-data
    # Start the health HAL for battery/charging info
    start health-hal-2-1
    # Set the default USB configuration to ADB
    setprop sys.usb.config adb

#---------------------------------------------------------------------
# Boot Complete Trigger
#---------------------------------------------------------------------
# Triggered after all core boot-time actions are finished.
on boot
    # Start the MediaTek preloader path linking utility service
    start mtk.plpath.utils.link

    #test if this file is being load
    mkdir /mnt/vendor/mt8781

#---------------------------------------------------------------------
# Property-Based Triggers
#---------------------------------------------------------------------
# These actions are triggered when a specific system property changes or is set.

# Creates symlinks for preloader (pl) partitions.
on property:persist.vendor.mtk.pl_lnk=1
    symlink /dev/block/mapper/pl_a /dev/block/by-name/preloader_raw_a
    symlink /dev/block/mapper/pl_b /dev/block/by-name/preloader_raw_b
    symlink /dev/block/mapper/pl_a /dev/block/platform/bootdevice/by-name/preloader_raw_a
    symlink /dev/block/mapper/pl_b /dev/block/platform/bootdevice/by-name/preloader_raw_b

# Aliases for LK (Little Kernel / Bootloader) partitions.
# This makes 'bootloader1' and 'bootloader2' valid partition names.
    symlink /dev/block/by-name/lk1 /dev/block/by-name/bootloader1
    symlink /dev/block/by-name/lk2 /dev/block/by-name/bootloader2

# Fixes for UFS boot partition linking in recovery.
# Creates mmcblk0bootX symlinks based on the UFS device path (sda, sdb, etc.).
on property:vendor.mtk.boot0_linka=1
    symlink /dev/block/sda /dev/block/mmcblk0boot0

on property:vendor.mtk.boot0_linkb=1
    symlink /dev/block/sdb /dev/block/mmcblk0boot0

on property:vendor.mtk.boot0_linkc=1
    symlink /dev/block/sdc /dev/block/mmcblk0boot0

on property:vendor.mtk.boot1_linka=1
    symlink /dev/block/sda /dev/block/mmcblk0boot1

on property:vendor.mtk.boot1_linkb=1
    symlink /dev/block/sdb /dev/block/mmcblk0boot1

on property:vendor.mtk.boot1_linkc=1
    symlink /dev/block/sdc /dev/block/mmcblk0boot1

#---------------------------------------------------------------------
# Service Definitions
#---------------------------------------------------------------------
# Defines a service to be run by init.

# Service for MediaTek preloader path utilities.
service mtk.plpath.utils.link /system/bin/mtk_plpath_utils
    class main
    user root
    group root system
    # 'oneshot': The service exits after running and does not restart.
    oneshot
    # 'disabled': This service will not start automatically;
    # it must be started by a trigger (see 'on boot').
    disabled
    # Sets the SELinux security context for the service.
    seclabel u:r:recovery:s0